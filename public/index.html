<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link
      rel="stylesheet"
      type="text/css"
      href="//fonts.googleapis.com/css?family=Playfair+Display"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
      integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
      integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
      integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Restaurant Rater</title>
  </head>
  <body>
    <div class="box">
      <div class="wrapper">
        <!-- header separated to 3 flex boxes -->
        <div class="header">
          <div class="left">
            <a href="index.html">
              <img id="logo" src="logo.jpg" alt="logo"
            /></a>
          </div>
          <div class="middle">
            <a href="index.html" class="item"><i class="fa fa-home"></i>Home</a>
            <a href="about.html" class="item">About</a>
            <a href="doc.html" class="item"><i class="fa fa-file"></i>Docs</a>
          </div>
          <div class="right">
            <div class="row">
              <div class="col-lg-6 offset-lg-3 col-sm-8 offset-sm-2 col-12">
                <div class="input-group" id="adv-search">
                  <input
                    type="text"
                    class="form-control form-control-search"
                    id="search"
                    placeholder="Search"
                    type="submit"
                  />
                  <div class="input-group-btn">
                    <div class="btn-group" role="group">
                      <div class="dropdown dropdown-lg">
                        <button
                          type="button"
                          class="btn btn-lg btn-secondary dropdown-toggle dropdown-toggle-split"
                          data-toggle="dropdown"
                          aria-haspopup="true"
                          aria-expanded="false"
                        ></button>
                        <div
                          class="dropdown-menu dropdown-menu-right"
                          role="menu"
                        >
                          <form id="options">
                            <div class="form-group">
                              <label for="category" class="text-dark"
                                >Category</label
                              >
                              <select class="form-control" id="category">
                                <option>Zip Code</option>
                                <option>Restaurant Name</option>
                                <option>Address</option>
                              </select>
                            </div>

                            <div class="form-group">
                              <label>Result Type</label><br />
                              <label class="custom-control custom-checkbox">
                                <input
                                  type="checkbox"
                                  class="custom-control-input"
                                  id="check1"
                                />
                                <span class="custom-control-indicator"></span>
                                <span class="custom-control-description"
                                  >Full</span
                                >
                              </label>
                              <label class="custom-control custom-checkbox">
                                <input
                                  type="checkbox"
                                  class="custom-control-input"
                                  id="check2"
                                />
                                <span class="custom-control-indicator"></span>
                                <span class="custom-control-description"
                                  >Safety Level</span
                                >
                              </label>
                            </div>
                          </form>
                        </div>
                      </div>
                      <button
                        id="searchB"
                        type="submit"
                        class="btn btn-primary"
                      >
                        <span class="fa fa-search" aria-hidden="true"></span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- conttent separated to 2 flex boxes -->
        <div class="content">
          <div id="mapid"></div>
          <div class="data" id="description">
            <h6>Instructions</h6>
            <ul>
              <li>
                Click the toggle dropdown to pick a
                category(Zipcode,Address,Restaurant Name) to input into the
                search bar(Case-insensitive)
              </li>
              <li>
                In the same toggle you can pick between gettting the full result
                or safete level
              </li>
              <li>
                Green Background means safe restaurant and red means the
                opposite
              </li>
              <li>
                Search example: Zipcode with Safety Level -> Restaurant Name with Safety
                Level -> Address with Safety level or Full result
              </li>
            </ul>
            <h6>Caution!</h6>
            <ul>
              <li>Don't search Zipcode with Full result</li>
              <li>
                Make sure to input correct values with associated category
              </li>
              <li>
                Background does not change for all search options
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <!-- map -->
    <script>
      var mymap = L.map("mapid").setView([38.9897, -76.9378], 13);
      var markers;
      L.tileLayer(
        "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",
        {
          attribution:
            'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
          maxZoom: 18,
          id: "mapbox/streets-v11",
          tileSize: 512,
          zoomOffset: -1,
          accessToken:
            "pk.eyJ1IjoidGFqaWRlIiwiYSI6ImNrOTdtaGl3MjA4MzEzZXByMjRzNWh3ZGEifQ.vVqCrdfxdkQ_XFENH2v7CA",
        }
      ).addTo(mymap);

      /*Custom sort for year*/
      function custom_sort(a, b) {
        return (
          new Date(a.inspection_date).getFullYear() -
          new Date(b.inspection_date).getFullYear()
        );
      }
      /*Goes through the data of test to change background of document to red or green based compliance*/
      function checkComp(res) {
        var keys = Object.keys(res);
        var check = true;
        for (let key = 11; key < keys.length - 5; key++) {
          const name = keys[key];
          const result = res[name];
          if (result === "Out of Compliance") {
            check = false;
            break;
          }
        }
        if (check)
          document.getElementById("description").style.backgroundColor =
            "#3ec92e";
        else
          document.getElementById("description").style.backgroundColor =
            "#FF0000";
        return check;
      }

      /*Makes a table version of json data( 2 columns) and ammends to to document.*/
      function jsonTable(res) {
        var table = document.createElement("table");
        table.className = "gridtable";
        var thead = document.createElement("thead");
        var tbody = document.createElement("tbody");
        var headRow = document.createElement("tr");
        ["Result Type", "Result"].forEach((el) => {
          var th = document.createElement("th");
          th.appendChild(document.createTextNode(el));
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);
        var keys = Object.keys(res);
        for (let key = 11; key < keys.length - 5; key++) {
          var tr = document.createElement("tr");
          const name = keys[key];
          const result = res[name];
          var td1 = document.createElement("td");
          var td2 = document.createElement("td");
          td1.appendChild(document.createTextNode(name));
          td2.appendChild(document.createTextNode(result));
          tr.appendChild(td1);
          tr.appendChild(td2);
          tbody.appendChild(tr);

          table.appendChild(tbody);
        }
        document.getElementById("description").appendChild(table);
      }
      /*Swap 2 value array element*/
      function swap(arr) {
        var tmp = arr[1];
        arr[1] = arr[0];
        arr[0] = tmp;
        return arr;
      }
      /*Makes a table version of json data(3 columns) and ammends to to document. It also adds markers to map*/
      function renderInfo(res, type) {
        var groups = [];
        var theMarker;
        var table = document.createElement("table");
        table.className = "gridtable";
        var thead = document.createElement("thead");
        var tbody = document.createElement("tbody");
        var headRow = document.createElement("tr");
        [type, "Result", "Inspection Year"].forEach((el) => {
          var th = document.createElement("th");
          th.appendChild(document.createTextNode(el));
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);
        for (key in res) {
          var tr = document.createElement("tr");
          theMarker = L.marker(
            swap(res[key].geocoded_column_1.coordinates)
          ).bindPopup(res[key].name);
          groups.push(theMarker);
          const name =
            type === "Name" ? res[key].name : res[key].address_line_1;

          const result = res[key].inspection_results;
          const year = new Date(res[key].inspection_date).getFullYear();
          var td1 = document.createElement("td");
          var td2 = document.createElement("td");
          var td3 = document.createElement("td");
          td1.appendChild(document.createTextNode(name));
          td2.appendChild(document.createTextNode(result));
          td3.appendChild(document.createTextNode(year));
          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tbody.appendChild(tr);

          table.appendChild(tbody);
        }
        markers = L.layerGroup(groups).addTo(mymap);

        document.getElementById("description").appendChild(table);
      }
      /*The main function that use all the functions above render results based on search bar*/
      function getInfo() {
        if (markers) markers.clearLayers();
        const searchBar = document.querySelector("#search");
        const category = document.querySelector("#category");
        const check1 = document.querySelector("#check1");
        const check2 = document.querySelector("#check2");
        document.getElementById("description").style.backgroundColor =
          "#FFCB9A";

        fetch("/api", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            searchBar: searchBar.value.toUpperCase(),
            category: category.value,
            check1: check1.checked,
            check2: check2.checked,
          }),
        })
          .then((data) => data.json())
          .then((res) => {
            if (
              searchBar.value.match(/^\d{5}$/) &&
              category.value === "Zip Code" &&
              check2.checked === true &&
              check1.checked === false
            ) {
              document.getElementById("description").innerHTML = "";
              renderInfo(res.sort(custom_sort), "Name");
            } else if (
              category.value === "Restaurant Name" &&
              check2.checked === true &&
              check1.checked === false &&
              !searchBar.value.match(/^\d{5}$/) &&
              !searchBar.value.match(
                /(\d{1,}) [a-zA-Z0-9\s]+(\.)?[ ]?[a-zA-Z]*/
              )
            ) {
              document.getElementById("description").innerHTML = "";
              renderInfo(res.sort(custom_sort), "Address");
            } else if (
              category.value === "Address" &&
              searchBar.value.match(
                /(\d{1,}) [a-zA-Z0-9\s]+(\.)?[ ]?[a-zA-Z]*/
              ) &&
              check2.checked === true &&
              check1.checked === false
            ) {
              document.getElementById("description").innerHTML = "";
              res = res.sort(custom_sort);
              renderInfo([res[res.length - 1]], "Name");
              checkComp(res[res.length - 1]);
            } else if (
              category.value === "Address" &&
              searchBar.value.match(
                /(\d{1,}) [a-zA-Z0-9\s]+(\.)?[ ]?[a-zA-Z]*/
              ) &&
              check2.checked === true &&
              check1.checked === true
            ) {
              document.getElementById("description").innerHTML = "";
              res = res.sort(custom_sort);
              renderInfo([res[res.length - 1]], "Name");
              jsonTable(res[res.length - 1]);
              checkComp(res[res.length - 1]);
            } else if (
              category.value === "Address" &&
              searchBar.value.match(
                /(\d{1,}) [a-zA-Z0-9\s]+(\.)?[ ]?[a-zA-Z]*/
              ) &&
              check2.checked === false &&
              check1.checked === true
            ) {
              document.getElementById("description").innerHTML = "";
              res = res.sort(custom_sort);
              jsonTable(res[res.length - 1]);
              L.marker(swap(res[res.length - 1].geocoded_column_1.coordinates))
                .addTo(mymap)
                .bindPopup(res[res.length - 1].name);
              checkComp(res[res.length - 1]);
            } else {
              if (check1 === true || check2 === true) {
                alert(
                  searchBar.value +
                    " can't be searched with  " +
                    category.value +
                    "and full result"
                );
              } else {
                alert("Wrong Value Inputed");
              }
            }
          });
      }
      const btn = document.querySelector("#searchB");
      btn.addEventListener("click", getInfo);
    </script>
  </body>
</html>
